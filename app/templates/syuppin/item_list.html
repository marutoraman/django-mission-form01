{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% load static %}
{% load mathfilters %}
{% block title %} 出品管理 {% endblock %}
{% block modal %}

<!--モーダル-->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content modal-witde">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">検索条件</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="GET">
                {% csrf_token %}
                <input name="amazon_group_id" type="hidden" value={{selection_amazon_get_id}}>
                <div class="modal-searchconditions-box">
                    <div class="modal-list-layout">
                        <label class="modal-label-title">{{ form_modal.sell_amazon.label_tag }}</label>
                        {{ form_modal.sell_amazon }}
                        {{ form_modal.sell_amazon.errors }}
                    </div>
                    <div>
                        <label class="modal-label-title"> {{ form_modal.cart_price_label.label_tag }}</label>
                        {{ form_modal.cart_price_min }}
                        {{ form_modal.cart_price_min.errors }}
                        ～
                        {{ form_modal.cart_price_max }}
                        {{ form_modal.cart_price_max.errors }}
                    </div>
                    <div>
                        <label class="modal-label-title">{{ form_modal.non_amazon_90days_label.label_tag }}</label>
                        {{ form_modal.non_amazon_90days_min }}
                        {{ form_modal.non_amazon_90days_min.errors }}
                        ～
                        {{ form_modal.non_amazon_90days_max }}
                        {{ form_modal.non_amazon_90days_max.errors }}
                    </div>
                    <div>
                        <label class="modal-label-title"> {{ form_modal.profit_label.label_tag }}</label>
                        {{ form_modal.profit_min }}
                        {{ form_modal.profit_min.errors }}
                        ～
                        {{ form_modal.profit_max }}
                        {{ form_modal.profit_max.errors }}
                    </div>
                    <div>
                        <label class="modal-label-title"> {{ form_modal.profit_rate_label.label_tag }}</label>
                        {{ form_modal.profit_rate_min }}
                        {{ form_modal.profit_rate_min.errors }}
                        ～
                        {{ form_modal.profit_rate_max }}
                        {{ form_modal.profit_rate_max.errors }}
                    </div>
                    <div class="modal-list-layout">
                        <label class="modal-label-title">{{ form_modal.item_quantity_exclusion.label_tag }}</label>
                        {{ form_modal.item_quantity_exclusion }}
                        {{ form_modal.item_quantity_exclusion.errors }}
                    </div>
                </div>

                <div class="modal-footer">
                    <button id="cancel" type="button" class="btn btn-secondary" data-dismiss="modal">キャンセル</button>
                    <button name="search_run" id="commit-item-data" type="submit" class="btn btn-primary">実行</button>
                </div>
            </form>
        </div>
    </div>
</div>
{%endblock%}

{% block contents %}
<div class="">
        <selection>
            <div class="section-header">
                <h1> 商品一覧 </h1>
            </div>
            <div>
                <div class="container float-left w-100">
		        <div class="row">
			    <div class="col-12 col-md-12 col-lg-12 p-0">
                <form id="main-form" class="form-horizontal" role="form" method="POST">
                    {% csrf_token %}
                    {% if messages %}
                        <ul class="messages_ul">
                            {% for message in messages %}
                                <li class="alert{% if message.tags %} alert-{{ message.tags }}{% endif %} alert-dismissible text-dark" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>{{ message }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="form-inline mt-1 p-0">
                        <button id="save-item-data" name="save-item-data" type="button" class="btn btn-primary">商品編集を保存</button>
                        <button id="export-excel" name="export-excel" class="btn btn-success ml-1">出品用Excelファイル出力</button>
                        <button name="delete-all" type="submit" class="btn btn-danger ml-1" id="delete-export-all">Excel出力済の商品を全削除</button>
                        <button name="delete" type="submit" class="btn btn-danger ml-3" id="delete">選択した商品を削除</button>
                        <button name="delete-all" type="submit" class="btn btn-danger ml-1" id="delete-all">全削除</button>
                        
                        
                    </div>

                    <div class="container-fluid p-0 mt-2">
                        <div class="form-inline">
                            <button id="check_all" class="btn btn-primary" type="button">全選択</button>
                            <button id="reset_all" class="ml-1 btn btn-secondary text-muted" type="button">全解除</button>
                            <select name="per_page" class="ml-3 form-control">
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="75">75</option>
                                <option value="100">100</option>
                                <option value="150">150</option>
                                <option value="200">200</option>
                            </select>
                            <button name="reload" class="ml-1 btn btn-primary">画面再表示</button>
                            <div class="ml-4">
                                <span class="control-label">商品取得の進捗状況</span>
                                <div class="progress" style="height: 30px;width: 300px">
                                    <div class="progress-bar progress-bar-striped bg-success" role="progressbar" 
                                         style="width: {{ progress }}%" aria-valuenow="{{completed_count}}" aria-valuemin="0" 
                                         aria-valuemax="{{all_count}}"><span class="font-weight-bold">{{ progress }}% ( {{all_count}}件中 {{completed_count}}件完了 )</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="control-label">商品件数：{{ record_count }}</div>
                        <div class="table table-hover table-header-checkbox-hidden syuppin-item-table sticky-table mt-2">
                            {% render_table table %}
                        </div>
                    </div>
                    <div class="form-inline mt-1 p-0">
                        <button id="save-item-data" name="save-item-data" type="button" class="btn btn-primary">商品編集を保存</button>
                        <button id="export-excel" name="export-excel" class="btn btn-success ml-1">出品用Excelファイル出力</button>
                    </div>
                </form>
            </div>
         </selection>
         </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    // delete(AJAXでPOST処理)
    $(document).ready(function (event) {
        // 削除ボタンがクリックされたら
        $("#delete").on('click', function (event) {
            // チェックボックスの状態をサーバーに伝えるために要素を追加
            var form = $('#main-form');
            $('[name="checkbox"]:checked').map(function () {
                $('<input>').attr({
                    'type': 'hidden',
                    'name': 'checkbox_selection',
                    'value': $(this).val()
                }).appendTo(form);
            });
            console.log(form)
            form.submit();
        });
    });

    // 全選択
    $('#check_all').on('click', function() {
        checkbox_list=document.getElementsByName("checkbox");
        checkbox_list.forEach( checkbox => checkbox.checked=true );
    });

    // 全解除
    $('#reset_all').on('click', function() {
        checkbox_list=document.getElementsByName("checkbox");
        checkbox_list.forEach( checkbox => checkbox.checked=false );
    });

    // 全削除時の警告
    $('#delete-all').on('click', function(event) {
        const res = window.confirm("全ページの商品を全て削除します。よろしいですか？削除した場合は復元できませんのでご注意ください。");
        if(!res){
            event.preventDefault();
        }
    });
    


    // 保存ボタンクリック時に一括でデータを更新する
    $("#save-item-data").on('click',function(event){
        event.preventDefault();
        var form = $('#main-form');
        
        // １ページのテーブル情報のうち、修正可能な部分の情報を取得
        $.each($('[name="item_row"]'), function(i, val) {
            let post_item_data={}
            post_item_data.id=$(this).data('id')
            post_item_data.amazon_price=$(this).find("[name='amazon_price']")[0].value
            post_item_data.item_name=$(this).find("[name='item_name']")[0].value
            post_item_data.description=$(this).find("[name='description']")[0].value
            post_item_data.is_image1_selected=$(this).find("[name='is_image1_selected']").prop("checked") ? "checked" : ""
            post_item_data.is_image2_selected=$(this).find("[name='is_image2_selected']").prop("checked") ? "checked" : ""
            post_item_data.is_image3_selected=$(this).find("[name='is_image3_selected']").prop("checked") ? "checked" : ""
            post_item_data.is_image4_selected=$(this).find("[name='is_image4_selected']").prop("checked") ? "checked" : ""
            post_item_data.is_image5_selected=$(this).find("[name='is_image5_selected']").prop("checked") ? "checked" : ""
            // クリックされたボタンのIDをサーバーに伝えるために要素を追加
            $('<input>').attr({
                'type': 'hidden',
                'name': 'post_item_data',
                'value': JSON.stringify(post_item_data)
            }).appendTo(form);
        });
        form.attr("method","POST") // POSTに変更
        // 押されたボタン情報を追加
        $('<input>').attr({
            'type': 'hidden',
            'name': 'save-item-data',
            'value': ''   
        }).appendTo(form);
        form.submit();
    });

    document.addEventListener("DOMContentLoaded", () => {
        
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        $('[name="yahoo_account_id"]').change(function(event){
            getAsinGroup()
        });

        // AsinGroupを取得する
        function getAsinGroup(){
            let yahoo_account_id = $('[name="yahoo_account_id"]').val();
            if(yahoo_account_id != "__all__"){
                $.ajax({
                    'url': '/api/select-asin-group',
                    'data': {"yahoo_account_id": yahoo_account_id},
                    'type': 'GET',
                    'dataType': 'json'
                }).done(res => {
                    $('[name="asin_group_id"] option').remove()
                    for( let i in res){
                        console.log(res)
                        $('[name="asin_group_id"]').append(`<option value="${res[i][0]}">${res[i][1]}</option>`)
                    }
                })
            }
        }

    })

</script>

{% endblock %}